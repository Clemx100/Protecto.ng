<!DOCTYPE html>
<html>
<head>
    <title>Real-time Chat Fix Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Real-time Chat Fix Test</h1>
    <div id="status">Connecting...</div>
    <div id="messages"></div>
    <button onclick="sendTestMessage()">Send Test Message</button>
    
    <script>
        const supabase = window.supabase.createClient(
            'https://kifcevffaputepvpjpip.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpZmNldmZmYXB1dGVwdnBqcGlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3OTQ0NzYsImV4cCI6MjA3NTM3MDQ3Nn0.8QZqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq'
        );
        
        const bookingId = '704ee613-c2d1-4c29-968f-0e5343c84580';
        
        function addMessage(msg) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${msg.sender_type}:</strong> ${msg.content || msg.message} <small>(${new Date(msg.created_at).toLocaleTimeString()})</small>`;
            document.getElementById('messages').appendChild(div);
        }
        
        function sendTestMessage() {
            fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bookingId: bookingId,
                    content: 'Test message from mobile at ' + new Date().toLocaleTimeString(),
                    senderType: 'client',
                    senderId: 'test-client'
                })
            }).then(r => r.json()).then(data => {
                console.log('Message sent:', data);
            });
        }
        
        // Set up real-time subscription
        const channel = supabase
            .channel('messages-fix-test')
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'messages',
                filter: `booking_id=eq.${bookingId}`
            }, (payload) => {
                console.log('Real-time message received:', payload);
                addMessage(payload.new);
            })
            .subscribe((status) => {
                console.log('Subscription status:', status);
                document.getElementById('status').textContent = 'Status: ' + status;
            });
        
        // Load existing messages
        fetch(`/api/messages?bookingId=${bookingId}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    data.data.forEach(addMessage);
                }
            });
    </script>
</body>
</html>